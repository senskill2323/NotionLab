Résumé

Résumé: Le panneau admin HomeBlockManagementPanel pilote les onglets liste (HomeBlockList) et bibliothèque (BlockSamplesPanel) avec persistance URL/sessionStorage et renvoie vers les écrans d’édition (EditHomeBlockPage, EditBlockSamplePage), tandis que le front (HomePage) et le dashboard (HomepagePanel) consomment homeBlockRegistry pour afficher/prévisualiser les blocs (src/components/admin/HomeBlockManagementPanel.jsx:7, src/components/admin/home-blocks/HomeBlockList.jsx:41, src/components/admin/home-blocks/BlockSamplesPanel.jsx:94, src/pages/admin/EditHomeBlockPage.jsx:24, src/pages/admin/EditBlockSamplePage.jsx:29, src/pages/HomePage.jsx:8, src/components/dashboard/modules/HomepagePanel.jsx:38, src/components/home/homeBlockRegistry.js:18).

Stack: React 18 + Shadcn UI + lucide + use-debounce pour l’interface admin (src/components/admin/home-blocks/HomeBlockList.jsx:1), React Hook Form/Tabs/Tiptap sur l’éditeur avancé (src/pages/admin/EditHomeBlockPage.jsx:12), framer-motion + upload dédié pour les previews (src/components/admin/home-blocks/CozySpaceSectionWithUpload.jsx:4), DOMPurify côté front/dash pour sécuriser HTML (src/pages/HomePage.jsx:3, src/components/dashboard/modules/HomepagePanel.jsx:9), client Supabase unique injecté partout (src/components/admin/home-blocks/HomeBlockList.jsx:17).

API publique: HomeBlockManagementPage (route admin) (src/pages/admin/HomeBlockManagementPage.jsx:5), HomeBlockManagementPanel (src/components/admin/HomeBlockManagementPanel.jsx:86), onglets HomeBlockList / BlockSamplesPanel (src/components/admin/home-blocks/HomeBlockList.jsx:894, src/components/admin/home-blocks/BlockSamplesPanel.jsx:622), éditeurs EditHomeBlockPage & EditBlockSamplePage (src/pages/admin/EditHomeBlockPage.jsx:492, src/pages/admin/EditBlockSamplePage.jsx:429), builder HomeBlockLayoutEditor + hook useHomeBlockEditor (src/components/admin/home-blocks/HomeBlockLayoutEditor.jsx:162, src/components/admin/home-blocks/useHomeBlockEditor.js:201), registre partagé homeBlockRegistry (src/components/home/homeBlockRegistry.js:28), module dashboard HomepagePanel (src/components/dashboard/modules/HomepagePanel.jsx:296), modale de preview (src/components/admin/home-blocks/BlockPreview.jsx:1).

Structure (fichiers): UI admin (src/components/admin/home-blocks/HomeBlockList.jsx:1 dépend de Supabase, Shadcn, icons, éditeur inline EditHomeBlockPage à src/components/admin/home-blocks/HomeBlockList.jsx:633; src/components/admin/home-blocks/BlockSamplesPanel.jsx:30 combine layoutRegistry + supabase block_samples), builder (src/components/admin/home-blocks/HomeBlockLayoutEditor.jsx:1, src/components/admin/home-blocks/layout-editors/index.js:1, src/components/admin/home-blocks/layoutRegistry.js:1, src/components/admin/home-blocks/layoutRegistry.shared.js:1), hooks (src/components/admin/home-blocks/useHomeBlockEditor.js:63), front (src/pages/HomePage.jsx:5, src/components/dashboard/modules/HomepagePanel.jsx:13), data/Edge (Supabase/functions/manage-content-block/index.ts:49, Supabase/functions/content-blocks-search/index.ts:17), règles SQL (sql/deploy_home_blocks_functions.sql:5).

Dépendances: Les définitions de layout alimentent seeds/templates (src/components/admin/home-blocks/layoutRegistry.js:479), BlockSamplesPanel construit ses payloads via buildHomeBlockEditorBundle (src/components/admin/home-blocks/BlockSamplesPanel.jsx:72), HomeBlockLayoutEditor orchestre les editors concrets (src/components/admin/home-blocks/HomeBlockLayoutEditor.jsx:5), HomeBlockList invoque EditHomeBlockPage en mode inline (src/components/admin/home-blocks/HomeBlockList.jsx:633), HomePage et HomepagePanel partagent homeBlockRegistry (src/components/home/homeBlockRegistry.js:18).

Flux de données: Chargement/filtrage content_blocks avec pagination et drapeaux via fetchContentBlocks + useSessionRefresh (src/components/admin/home-blocks/HomeBlockList.jsx:178, src/components/admin/home-blocks/HomeBlockList.jsx:228); actions atomiques sur les blocs via RPC home_blocks_* et Edge manage-content-block lors des créations/duplications/édition (src/components/admin/home-blocks/HomeBlockList.jsx:364, src/components/admin/home-blocks/HomeBlockList.jsx:536, src/pages/admin/EditHomeBlockPage.jsx:211, src/pages/admin/EditHomeBlockPage.jsx:224); la bibliothèque seed/importe block_samples puis crée des brouillons Supabase (src/components/admin/home-blocks/BlockSamplesPanel.jsx:183, src/components/admin/home-blocks/BlockSamplesPanel.jsx:408).

État & effets: Synchronisation onglet/URL/sessionStorage côté panneau (src/components/admin/HomeBlockManagementPanel.jsx:9, src/components/admin/HomeBlockManagementPanel.jsx:45); la liste mémorise mode/ID d’édition en sessionStorage et throttle la recherche (src/components/admin/home-blocks/HomeBlockList.jsx:47, src/components/admin/home-blocks/HomeBlockList.jsx:150); rafraîchissement via bus custom (src/components/admin/home-blocks/HomeBlockList.jsx:228, src/lib/sessionRefreshBus.js:3); la bibliothèque debounce sa recherche et effectue un seed unique (src/components/admin/home-blocks/BlockSamplesPanel.jsx:117, src/components/admin/home-blocks/BlockSamplesPanel.jsx:183); useHomeBlockEditor encapsule reset/hydratation/sérialisation (src/components/admin/home-blocks/useHomeBlockEditor.js:63).

I/O DB (PostgREST/RPC/SQL): Sélection content_blocks paginée + updates de priorité/ordre/statut (src/components/admin/home-blocks/HomeBlockList.jsx:192, src/components/admin/home-blocks/HomeBlockList.jsx:273, src/components/admin/home-blocks/HomeBlockList.jsx:300, src/components/admin/home-blocks/HomeBlockList.jsx:414); RPC home_blocks_move/set_status/duplicate/set_title/delete_hard pour les actions (src/components/admin/home-blocks/HomeBlockList.jsx:364, src/components/admin/home-blocks/HomeBlockList.jsx:376, src/components/admin/home-blocks/HomeBlockList.jsx:400, src/components/admin/home-blocks/HomeBlockList.jsx:610, src/components/admin/home-blocks/HomeBlockList.jsx:665); EditHomeBlockPage bascule entre PostgREST et home_blocks_create_html/Edge selon le type (src/pages/admin/EditHomeBlockPage.jsx:139, src/pages/admin/EditHomeBlockPage.jsx:211, src/pages/admin/EditHomeBlockPage.jsx:224); bibliothèque CRUD sur block_samples + création via Edge (src/components/admin/home-blocks/BlockSamplesPanel.jsx:183, src/components/admin/home-blocks/BlockSamplesPanel.jsx:408); Edge manage-content-block insère/maj content_blocks avec service-role (Supabase/functions/manage-content-block/index.ts:49, Supabase/functions/manage-content-block/index.ts:65); Edge content-blocks-search proxifie search_content_blocks (Supabase/functions/content-blocks-search/index.ts:17); SQL home_blocks_* fournit la logique serveur sécurisée (sql/deploy_home_blocks_functions.sql:5, sql/deploy_home_blocks_functions.sql:45, sql/deploy_home_blocks_functions.sql:97, sql/deploy_home_blocks_functions.sql:143, sql/deploy_home_blocks_functions.sql:187, sql/deploy_home_blocks_functions.sql:211).
Realtime (listen/broadcast): Pas de canal Supabase direct; rafraîchissement côté admin via un CustomEvent (src/lib/sessionRefreshBus.js:3, src/components/admin/home-blocks/HomeBlockList.jsx:228).
Sécurité (RLS, XSS, CSRF): HTML public/dash assaini avec DOMPurify (src/pages/HomePage.jsx:57, src/components/dashboard/modules/HomepagePanel.jsx:102); Edge manage-content-block nettoie les payloads mais exploite la clé service-role (à restreindre) (Supabase/functions/manage-content-block/index.ts:16, Supabase/functions/manage-content-block/index.ts:65); RPC home_blocks_delete_hard impose un contrôle owner/admin via SECURITY DEFINER (sql/deploy_home_blocks_functions.sql:5, sql/deploy_home_blocks_functions.sql:17).