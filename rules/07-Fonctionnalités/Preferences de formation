Résumé

Module client client_training_preferences = espace onboarding complet (résumé + wizard) exposé dans le dashboard et via routes dédiées ClientOnlyRoute (src/App.jsx:101).
UX : panneau récap (src/components/dashboard/modules/TrainingPreferencesPanel.jsx:1) + page détaillée (src/pages/TrainingPreferencesPage.jsx:1) + assistant wizard (src/pages/TrainingPreferencesWizardPage.jsx:1).
Données : API Supabase centralisée (src/lib/trainingOnboardingApi.js:1) couvrant sections/questions/réponses/NPS + Edge notify-training-onboarding.
Règles : migration 2025-09-20_training_onboarding_form.sql crée le squelette (tables, RLS, permission training_preferences:view_module, module registry) + Edge function notify-training-onboarding (email).
Stack

React 18, React Router 6, React Query, React Helmet, Radix Slider, use-debounce, clsx.
UI : shadcn UI, lucide-react, framer-motion (dashboard integration).
State/side-effects : React Query for fetch/mutations, useState/useEffect/useMemo, useDebounce pour autosave.
Data : Supabase JS client (REST + storage + Edge).
Notifications : Edge function notify-training-onboarding (Resend).
API publique

TrainingPreferencesPanel (src/components/dashboard/modules/TrainingPreferencesPanel.jsx:1) → default export, props none, lit TrainingPreferencesSummary.
TrainingPreferencesPage (src/pages/TrainingPreferencesPage.jsx:1) → default export, route /mes-preferences-formation.
TrainingPreferencesWizardPage (src/pages/TrainingPreferencesWizardPage.jsx:1) → default export, route /mes-preferences-formation/editer.
TrainingPreferencesSummary (src/components/onboarding/TrainingPreferencesSummary.jsx:1) → default export, props { sections, answers, status, lastSubmittedAt, draftSavedAt, isAdminView }.
TrainingOnboardingWizard (src/components/onboarding/TrainingOnboardingWizard.jsx:1) → default export, prop onCompleted.
API helpers (src/lib/trainingOnboardingApi.js:134-307) : fetchTrainingOnboardingConfig, fetchTrainingOnboardingConfigWithAllQuestions, fetchTrainingOnboardingResponse, saveTrainingOnboardingDraft, submitTrainingOnboardingResponses, fetchTrainingOnboardingNps, recordTrainingOnboardingNps, notifyOnboardingSubmission.
Structure (fichiers)

Sous-agent UI
src/components/dashboard/modules/TrainingPreferencesPanel.jsx:1 export default panel; dépend de React Query, Supabase Auth, TrainingPreferencesSummary.
src/pages/TrainingPreferencesPage.jsx:1 export default page; dépend Helmet, useNavigate, React Query, Summary.
src/pages/TrainingPreferencesWizardPage.jsx:1 export default wizard screen; dépend TrainingOnboardingWizard.
src/components/onboarding/TrainingPreferencesSummary.jsx:1 export default summary; dépend lucide-react, shadcn UI.
src/components/onboarding/TrainingOnboardingWizard.jsx:1 export default form; sous-composants internes (StepIndicator, QuestionBlock, etc.) + hooks React Query + Radix slider + useToast.
Integrations : src/components/dashboard/ClientDashboardContent.jsx:15 map module key → panel; src/components/UserAccountPanel.jsx:85 menu entry; src/pages/admin/ModuleManagerPage.jsx:17 preview map; src/components/admin/formation-live/OnboardingBriefPanel.jsx:1 réemploi summary.
Sous-agent Data
src/lib/trainingOnboardingApi.js:1 centralise requêtes Supabase (sections, questions, options, responses, NPS) + Edge invoke.
Supabase Edge Supabase/functions/notify-training-onboarding/index.ts:1 envoi email via Resend, fallback log.
Sous-agent Règles
Supabase/migrations/2025-09-20_training_onboarding_form.sql:1 tables + RLS + seeds + permission + module registry.
Supabase/migrations/2025-09-21_fix_training_onboarding_accents.sql:1 & _unicode.sql correctifs libellés.
rules/00-architecture/readme.mdc:90 recense module.
Permission associée training_preferences:view_module (migration lignes ~724).
Module registry client_training_preferences (migration lignes ~730).
Dépendances

Internes : useAuth, usePermissions, useToast, ClientOnlyRoute, ModuleManager preview, admin Onboarding panels, Edge notify function.
Externes : @tanstack/react-query, use-debounce, @radix-ui/react-slider, lucide-react, clsx, Supabase JS, Resend.
Flux de données

Dashboard panel/page : useQuery → fetchTrainingOnboardingConfigWithAllQuestions + fetchTrainingOnboardingResponse; affiche summary ou call-to-action.
Wizard : charge config active (fetchTrainingOnboardingConfig) + réponse (fetchTrainingOnboardingResponse), hydrate answers, autosave (debounced) via saveTrainingOnboardingDraft, soumission via submitTrainingOnboardingResponses (upsert) puis notification Edge + éventuel update profiles.profession.
After submit : conditionne pop-up NPS -> recordTrainingOnboardingNps -> local Query cache update.
Admin brief : même queries mais flag isAdminView.
Dashboard layout : module visible condition permission (module_registry + usePermissions).
Navigation : menu utilisateur -> route -> page/wizard.
État & effets

React Query handles remote state; error/loading gating in panel/page/wizard (src/components/dashboard/modules/TrainingPreferencesPanel.jsx:18, src/pages/TrainingPreferencesPage.jsx:19, src/components/onboarding/TrainingOnboardingWizard.jsx:452).
Wizard : answers, currentStep, saveState, lastSavedAt, showNpsDialog, pendingRedirectAfterNps via useState; hydration effect + debounced autosave; useRef caches last response.
Summary uses useMemo to precompute sections/items (src/components/onboarding/TrainingPreferencesSummary.jsx:41).
useNavigate used to redirect after actions.
I/O DB (PostgREST/RPC/SQL)

Tables : training_onboarding_sections, training_onboarding_questions, training_onboarding_question_options, training_onboarding_responses, training_onboarding_nps, profiles.
Queries:
select nested (sections/questions/options) (trainingOnboardingApi.js:136,289).
select response by user_id (trainingOnboardingApi.js:166).
upsert draft/submit on training_onboarding_responses (trainingOnboardingApi.js:178,209).
select/upsert NPS (trainingOnboardingApi.js:252,277).
supabase.from('profiles').update profession en soumission (TrainingOnboardingWizard.jsx:568).
Edge invoke notify-training-onboarding (trainingOnboardingApi.js:310).
Realtime (listen/broadcast)

Aucun canal realtime propre au module ; rafraîchissement manuel via React Query refetch (no supabase.channel usage).
Notifications push = e-mail via Edge; pas de broadcast tableau de bord.
Sécurité (RLS, XSS, CSRF)

RLS activée sur toutes les tables onboarding avec policies (self-select/insert/update + admin manage) (Supabase/migrations/2025-09-20_training_onboarding_form.sql:60-210).
Permission gating : modules_registry requiert training_preferences:view_module, assignée via role_permissions seeds (Supabase/migrations/2025-09-20_training_onboarding_form.sql:724).
profiles update dépend RLS de public.profiles (à vérifier : si non protégée, risque d’élévation).
Form inputs : rendu JSX -> XSS limité; summary escape by default, multi-line -> whitespace-pre-line.
CSRF géré par Supabase session tokens; SPA only.